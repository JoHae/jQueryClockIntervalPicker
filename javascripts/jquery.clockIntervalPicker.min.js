$(function(){$.widget("jh.clockTimeIntervalPicker",{options:{width:500,height:500,circleRadius:200,multiSelection:!0,showFaceCircle:!1,enableAmPmButtons:!0,showToggleLayoutButton:!1,showHourLabels:!1,faceTicksLargeLength:10,faceTicksLargeOptions:{strokeWidth:5},faceTicksTinyLength:5,faceTicksTinyOptions:{strokeWidth:2},faceCircleOptions:{fill:"black",fillOpacity:0,stroke:"black",strokeOpacity:0,strokeWidth:2},faceOverlayOptions:{fill:"blue",fillOpacity:.4,stroke:"blue",strokeOpacity:.4,strokeWidth:1}},
_create:function(){var a=this,b=0,c=0,d=!1,e=this.options.circleRadius+24;this.options.showFaceCircle&&(e+=this.options.faceCircleOptions.strokeWidth);this.actualStartTime=null;this.selectedIntervals=[];this.intervalCount=0;this.ctrlHold=!1;this.pmEnabled=this.amEnabled=!0;this.actualArcStartPoint={};this.arcPath=null;this.interactionGroups=[];this.svg=null;this.element.css("width",this.options.width);this.element.css("height",this.options.height);this.element.css("position","relative");this.interactionGroupOptions=
this.options.faceOverlayOptions;this.interactionGroupOptions.transform="translate("+e+","+e+")";this._createElements(e);this.element.svgContainer.mousedown(function(b){a._clearTextSelection();3==b.which?0<a.intervalCount?(a._clearSelection(),a.element.trigger("selectionChanged",{intervals:{}})):(a.amEnabled&&a.selectedIntervals.push({startTime:{hours:0,minutes:0},endTime:{hours:11,minutes:59}}),a.pmEnabled&&a.selectedIntervals.push({startTime:{hours:12,minutes:0},endTime:{hours:23,minutes:59}}),a.interactionGroups.push(a.svg.group(a.interactionGroupOptions)),
a.svg.circle(a.interactionGroups[a.intervalCount],0,0,a.options.circleRadius),a.intervalCount++,a.element.trigger("selectionChanged",{intervals:a.selectedIntervals})):(a.ctrlHold=b.ctrlKey&&a.options.multiSelection,a.ctrlHold||a._clearSelection(),a.actualArcStartPoint=a._getArcPointFromAbsolutePosition(b.pageX,b.pageY),a._drawSvgArc(null),a.actualStartTime=a._getTimeFromAbsolutePosition(b.pageX,b.pageY),d=!0,a.element.trigger("selectionStarted",{intervals:a._getIntervalsFromTimeObj(a.actualStartTime,
null,a.amEnabled,a.pmEnabled)}))});this.element.svgContainer.mouseup(function(b){3!=b.which&&(a._clearTextSelection(),b=a._getTimeFromAbsolutePosition(b.pageX,b.pageY),a.intervalCount++,d=!1,b=a._getIntervalsFromTimeObj(a.actualStartTime,b,a.amEnabled,a.pmEnabled),a.selectedIntervals=a.selectedIntervals.concat(b),a.actualStartTime=null,a.element.trigger("selectionEnded",{intervals:b}),a.element.trigger("selectionChanged",{intervals:a.selectedIntervals}))});this.element.svgContainer.mouseleave(function(){a.element.tooltipContainer.hide()});
this.element.svgContainer.mouseenter(function(){a.element.tooltipContainer.show()});this.element.svgContainer.mousemove(function(f){if(f.pageX!=c||f.pageY!=b){c=f.pageX;b=f.pageY;a._clearTextSelection();f=a._getRelativePosition(c,b);f=a._getAngleFromRelativePosition(f.x,f.y);var g=a._getTimeFromAngle(f),e=a.element.offset();a.element.tooltipContainer.css("left",c-e.left+15).css("top",b-e.top).text(a._getTooltipText(g));d&&(f+=180,g=a._polarToCartesian(0,0,a.options.circleRadius,f),a._drawSvgArc(g,
f))}})},_getRelativePosition:function(a,b){var c=this.element.svgContainer.offset();return{x:a-c.left,y:b-c.top}},_clearTextSelection:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},_getTimeFromAbsolutePosition:function(a,b){var c=this._getRelativePosition(a,b),c=this._getAngleFromRelativePosition(c.x,c.y);return this._getTimeFromAngle(c)},
_getArcPointFromAbsolutePosition:function(a,b){var c=this._getRelativePosition(a,b),c=this._getAngleFromRelativePosition(c.x,c.y),d=Math.PI/180*(c+180)*-1;return{x:this.options.circleRadius*Math.cos(d),y:this.options.circleRadius*Math.sin(d)*-1,angle:c}},_getAngleFromRelativePosition:function(a,b){var c=this.svgWidthHeight/2;return 180*Math.atan2(c-b,c-a)/Math.PI},_getTooltipText:function(a){var b="",c="";this.amEnabled&&this.pmEnabled?c="AM/PM":this.amEnabled?c="AM":this.pmEnabled&&(c="PM");if(null!=
this.actualStartTime){b+=this._timeObjectToString(this.actualStartTime);this.amEnabled&&this.pmEnabled||(b+=" "+c);var b=b+" - ",d=this.actualStartTime.hours-a.hours;12>this.actualStartTime.hours&&(12<=a.hours||0<d||0==d&&this.actualStartTime.minutes>a.minutes)&&("AM"==c?c="PM":"PM"==c&&(c="AM"))}return b+=this._timeObjectToString(a)+" "+c},_polarToCartesian:function(a,b,c,d){d=d*Math.PI/180;return{x:a+c*Math.cos(d),y:b+c*Math.sin(d)}},_getTimeFromAngle:function(a){var b=3-1/30*((a+180)%360)*-1;0>
b&&(b+=12);12<b&&(b-=12);a=parseInt(b);0==a&&(a=12);b=parseInt(60*b)%60;return{hours:a,minutes:b}},_getIntervalsFromTimeObj:function(a,b,c,d){var e=[],f=$.extend({},a),g=$.extend({},b);c&&d?(c=$.extend({},a),d=$.extend({},b),12==a.hours&&(f.hours-=12),null!=b?(b.hours<a.hours&&12>a.hours&&(g.hours+=12),e.push({startTime:f,endTime:g})):e.push({startTime:f}),12>a.hours&&(c.hours+=12),null!=b?(12>b.hours&&b.hours>a.hours&&(d.hours+=12),b.hours<=a.hours&&12==b.hours&&(d.hours-=12),e.push({startTime:c,
endTime:d})):e.push({startTime:c})):d?(12>a.hours&&(f.hours+=12),null!=b?(12>b.hours&&b.hours>a.hours&&(g.hours+=12),b.hours<=f.hours&&12==b.hours&&(g.hours-=12),e.push({startTime:f,endTime:g})):e.push({startTime:f})):c?(12==a.hours&&(f.hours-=12),null!=b?(b.hours<a.hours&&12>a.hours&&(g.hours+=12),e.push({startTime:f,endTime:g})):e.push({startTime:f})):console.error("Illegal State: AM/PM");return e},_drawSvgArc:function(a,b){if(!this.ctrlHold)this._clearArcGroups();else if(this.interactionGroups.length>=
this.intervalCount)for(var c=this.intervalCount;c<this.interactionGroups.length;c++)this.svg.remove(this.interactionGroups[c]),this.interactionGroups.pop();this.interactionGroups.length!=this.intervalCount&&(console.error("length: "+this.interactionGroups.length),console.error("Count:  "+this.intervalCount));this.interactionGroups.push(this.svg.group(this.interactionGroupOptions));this.arcPath=this.svg.createPath();if(null==a)this.arcPath.move(0,0).line([[0,0],[this.actualArcStartPoint.x,this.actualArcStartPoint.y]]).close();
else{var d,c=this.actualArcStartPoint.angle+180-b;90<=this.actualArcStartPoint.angle&&180>=this.actualArcStartPoint.angle?d=0>c&&-90<c||360>=c&&180<c?0:1:-90>=this.actualArcStartPoint.angle&&-180<=this.actualArcStartPoint.angle||-90<=this.actualArcStartPoint.angle&&0>=this.actualArcStartPoint.angle?d=-180<c&&0>c?0:1:0<=this.actualArcStartPoint.angle&&90>=this.actualArcStartPoint.angle&&(d=0>c&&-180<c||180<c?0:1);this.arcPath.move(0,0).line([[0,0],[this.actualArcStartPoint.x,this.actualArcStartPoint.y]]).arc(this.options.circleRadius,
this.options.circleRadius,1,d,1,a.x,a.y).line([[a.x,a.y],[0,0]]).close()}this.svg.path(this.interactionGroups[this.intervalCount],this.arcPath)},_clearArcGroups:function(){if(0<this.interactionGroups.length)for(var a=0;a<this.interactionGroups.length;a++)this.svg.remove(this.interactionGroups[a]);this.interactionGroups=[]},_clearSelection:function(){this.actualStartTime=null;this.actualArcStartPoint={};this.intervalCount=0;this.selectedIntervals=[];this._clearArcGroups();this.arcPath=null},_timeObjectToString:function(a){return(10>
a.hours?"0"+a.hours:a.hours)+":"+(10>a.minutes?"0"+a.minutes:a.minutes)},_createElements:function(a){var b=this;this.element.tooltipContainer=$("<div></div>").attr("id","jh-tooltip-container").hide().appendTo(this.element);var c;if(this.options.showToggleLayoutButton||this.options.enableAmPmButtons){var d=$("<div></div>").attr("id","jh-button-container").appendTo(this.element);if(this.options.showToggleLayoutButton){var e=$("<div></div>").attr("id","jh-toggle-button-container").css("float","left").appendTo(d).css("float",
"right");$(' <input type="checkbox" id="clockLayout"><label for="clockLayout">24h</label> ').appendTo(e);$("#clockLayout").button().on("change",function(){var a=$(this).is(":checked");b.showTwentyFourClockLayout=a;"undefined"!==typeof c&&(a?c.hide():c.show())})}this.options.enableAmPmButtons&&(c=$("<div></div>").attr("id","jh-am-pm-button-container").css("float","left").appendTo(d),$(' <input type="radio" id="jh-am-button" name="radio" value="AM"><label for="jh-am-button">AM</label>').appendTo(c),
$(' <input type="radio" id="jh-pm-button" name="radio" value="PM"><label for="jh-pm-button">PM</label>').appendTo(c),$(' <input type="radio" id="jh-both-button" name="radio"  value="AM/PM" checked="checked"><label for="jh-both-button">AM/PM</label>').appendTo(c),c.buttonset(),$("input:radio[name=radio]").change(function(){b.amEnabled=!1;b.pmEnabled=!1;"AM"==this.value?b.amEnabled=!0:"PM"==this.value?b.pmEnabled=!0:"AM/PM"==this.value&&(b.amEnabled=!0,b.pmEnabled=!0)}))}this.svgWidthHeight=2*(this.options.circleRadius+
24);this.options.showFaceCircle&&(this.svgWidthHeight+=2*this.options.faceCircleOptions.strokeWidth);this.element.svgContainer=$("<div></div>").attr("id","jh-svg-container").width(this.svgWidthHeight).height(this.svgWidthHeight).attr("oncontextmenu","return false;").appendTo(this.element);this.element.svgContainer.svg({onLoad:function(c){b.svg=c;$(c.root()).attr("width","100%").attr("height","100%");var d=b.options.circleRadius,e=b.svgWidthHeight/2;b.options.showFaceCircle&&c.circle(e,e,d,b.options.faceCircleOptions);
for(var d=c.group({stroke:"black",transform:"translate("+a+","+a+")"}),k=b.options.circleRadius-b.options.faceTicksTinyLength,e=0;360>e;e+=6){var h=b.options.faceTicksTinyOptions;h.transform="rotate("+e+")";c.line(d,0,b.options.circleRadius,0,k,h)}k=b.options.circleRadius-b.options.faceTicksLargeLength;for(e=0;360>e;e+=30)h=b.options.faceTicksLargeOptions,h.transform="rotate("+e+")",c.line(d,0,b.options.circleRadius,0,k,h);b.options.showHourLabels&&(c.text(d,0,b.options.circleRadius+24,"6"),c.text(d,
-b.options.circleRadius-24,0,"9"),c.text(d,0,-b.options.circleRadius-24,"12"),c.text(d,b.options.circleRadius+24,0,"3"),$("text",c.root()).attr("text-anchor","middle").addClass("hour-label"))}})},_destroy:function(){},_setOption:function(a,b){$.Widget.prototype._setOption.apply(this,arguments)}})});